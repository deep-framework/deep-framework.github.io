<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/Vogels/ExtendModel.js | DEEP Database Library API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/MitocGroup/deep-framework.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/DB.js~DB.html">DB</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">DynamoDB</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/DynamoDB/AutoScaleDynamoDB.js~AutoScaleDynamoDB.html">AutoScaleDynamoDB</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Exception</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Exception/Exception.js~Exception.html">Exception</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Exception/FailedToCreateTableException.js~FailedToCreateTableException.html">FailedToCreateTableException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Exception/FailedToCreateTablesException.js~FailedToCreateTablesException.html">FailedToCreateTablesException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Exception/ModelNotFoundException.js~ModelNotFoundException.html">ModelNotFoundException</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Local</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/DBServer.js~DBServer.html">DBServer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Local/Driver</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/AbstractDriver.js~AbstractDriver.html">AbstractDriver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/Dynalite.js~Dynalite.html">Dynalite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/LocalDynamo.js~LocalDynamo.html">LocalDynamo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/PathAwareDriver.js~PathAwareDriver.html">PathAwareDriver</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Local/Driver/Exception</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/Exception/Exception.js~Exception.html">Exception</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/Exception/FailedToStartServerException.js~FailedToStartServerException.html">FailedToStartServerException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/Exception/ServerAlreadyRunningException.js~ServerAlreadyRunningException.html">ServerAlreadyRunningException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Local/Driver/Exception/ServerTtsExceededException.js~ServerTtsExceededException.html">ServerTtsExceededException</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Vogels</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Vogels/ExtendModel.js~ExtendModel.html">ExtendModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Vogels/Exceptions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Vogels/Exceptions/Exception.js~Exception.html">Exception</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Vogels/Exceptions/InvalidArgumentException.js~InvalidArgumentException.html">InvalidArgumentException</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/Vogels/Exceptions/UndefinedMethodException.js~UndefinedMethodException.html">UndefinedMethodException</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/Vogels/ExtendModel.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Created by Stefan Hariton on 6/26/15.
 */

&apos;use strict&apos;;

import UndefinedMethodException from &apos;./Exceptions/UndefinedMethodException&apos;;
import util from &apos;util&apos;;

/**
 * Extends standard Vogels models
 */
export class ExtendModel {
  /**
   * @param {Object} model
   */
  constructor(model) {
    this._model = model;
  }

  /**
   * @returns {Object}
   */
  get model() {
    return this._model;
  }

  /**
   * @returns {Number}
   */
  static get DEFAULT_LIMIT() {
    return 10;
  }

  /**
   * @returns {number}
   */
  static get DEFAULT_SEGMENTS_NUMBER() {
    return 4;
  }

  /**
   * Makes filterExpression, filtersExpressionValues and filterExpressionNames from an object, that are used to make
   * a DynamoDb scan
   *
   * @param {Object} params
   * @returns {Object}
   */
  static buildScanParameters(params) {
    let filterExpression = &apos;&apos;;
    let filterExpressionValues = {};
    let filterExpressionNames = {};
    let first = true;

    for (let key in params) {
      if (!params.hasOwnProperty(key)) {
        continue;
      }

      let fieldValue = params[key];

      let fieldName = `#${key}`;
      let fieldValueName = `:${key}`;

      if (!first) {
        filterExpression += &apos; AND &apos;;
      }

      filterExpression += `${fieldName} = ${fieldValueName}`;
      filterExpressionValues[fieldValueName] = fieldValue;
      filterExpressionNames[fieldName] = key;
      first = false;
    }

    return {
      filterExpression: filterExpression,
      filterExpressionValues: filterExpressionValues,
      filterExpressionNames: filterExpressionNames,
    };
  }

  /**
   * @returns {Object}
   */
  get methods() {
    let _this = this;

    return {
      findAll: function(cb) {
        _this._logRumEvent({ eventName: &apos;findAll&apos; });

        return _this.model.scan().loadAll().exec((error, model) =&gt; {
          _this._extendedCallback(&apos;findAll&apos;, error, model, cb);
        });
      },

      findAllPaginated: function(startKey, limit, cb) {
        _this._logRumEvent({
          eventName: &apos;findAllPaginated&apos;,
          payload: {startKey, limit},
        });

        return _this.model
          .scan()
          .startKey(startKey)
          .limit(limit)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findAllPaginated&apos;, error, model, cb);
          });
      },

      findOneById: function(id, cb) {
        _this._logRumEvent({
          eventName: &apos;findOneById&apos;,
          payload: {id},
        });

        return _this.model.get(id, (error, model) =&gt; {
          _this._extendedCallback(&apos;findOneById&apos;, error, model, cb);
        });
      },

      findOneBy: function(fieldName, value, cb) {
        _this._logRumEvent({
          eventName: &apos;findOneBy&apos;,
          payload: {fieldName, value},
        });

        return _this.model
          .scan()
          .where(fieldName).equals(value)
          .limit(1)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findOneBy&apos;, error, model, cb);
          });
      },

      findBy: function(fieldName, value, cb, limit = ExtendModel.DEFAULT_LIMIT) {
        _this._logRumEvent({
          eventName: &apos;findBy&apos;,
          payload: {fieldName, value, limit},
        });

        return _this.model
          .scan()
          .where(fieldName).equals(value)
          .limit(limit)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findBy&apos;, error, model, cb);
          });
      },

      findAllBy: function(fieldName, value, cb) {
        _this._logRumEvent({
          eventName: &apos;findAllBy&apos;,
          payload: {fieldName, value},
        });

        return _this.model
          .scan()
          .where(fieldName).equals(value)
          .loadAll()
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findAllBy&apos;, error, model, cb);
          });
      },

      findAllByPaginated: function(fieldName, value, startKey, limit, cb) {
        _this._logRumEvent({
          eventName: &apos;findAllByPaginated&apos;,
          payload: {fieldName, value, startKey, limit},
        });

        return _this.model
          .scan()
          .where(fieldName).equals(value)
          .startKey(startKey)
          .limit(limit)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findAllByPaginated&apos;, error, model, cb);
          });
      },

      findMatching: function(params, cb, limit = ExtendModel.DEFAULT_LIMIT) {
        _this._logRumEvent({
          eventName: &apos;findMatching&apos;,
          payload: {params, limit},
        });

        let scanParams = ExtendModel.buildScanParameters(params);

        return _this.model
          .scan()
          .filterExpression(scanParams.filterExpression)
          .expressionAttributeValues(scanParams.filterExpressionValues)
          .expressionAttributeNames(scanParams.filterExpressionNames)
          .limit(limit)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findMatching&apos;, error, model, cb);
          });
      },

      findOneMatching: function(params, cb) {
        _this._logRumEvent({
          eventName: &apos;findOneMatching&apos;,
          payload: {params},
        });

        let scanParams = ExtendModel.buildScanParameters(params);

        return _this.model
          .scan()
          .filterExpression(scanParams.filterExpression)
          .expressionAttributeValues(scanParams.filterExpressionValues)
          .expressionAttributeNames(scanParams.filterExpressionNames)
          .limit(1)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findMatching&apos;, error, model, cb);
          });
      },

      findAllMatching: function(params, cb) {
        _this._logRumEvent({
          eventName: &apos;findAllMatching&apos;,
          payload: {params},
        });

        let scanParams = ExtendModel.buildScanParameters(params);

        return _this.model
          .scan()
          .filterExpression(scanParams.filterExpression)
          .expressionAttributeValues(scanParams.filterExpressionValues)
          .expressionAttributeNames(scanParams.filterExpressionNames)
          .loadAll()
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findAllMatching&apos;, error, model, cb);
          });
      },

      findAllMatchingPaginated: function(params, startKey, limit, cb) {
        _this._logRumEvent({
          eventName: &apos;findAllMatchingPaginated&apos;,
          payload: {params, startKey, limit},
        });

        let scanParams = ExtendModel.buildScanParameters(params);

        return _this.model
          .scan()
          .filterExpression(scanParams.filterExpression)
          .expressionAttributeValues(scanParams.filterExpressionValues)
          .expressionAttributeNames(scanParams.filterExpressionNames)
          .startKey(startKey)
          .limit(limit)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;findAllMatchingPaginated&apos;, error, model, cb);
          });
      },

      deleteById: function(id, cb) {
        _this._logRumEvent({
          eventName: &apos;deleteById&apos;,
          payload: {id},
        });

        return _this.model.destroy(id, (error, model) =&gt; {
          _this._extendedCallback(&apos;deleteById&apos;, error, model, cb);
        });
      },

      deleteByIdConditional: function(id, condition, cb) {
        _this._logRumEvent({
          eventName: &apos;deleteByIdConditional&apos;,
          payload: {id, condition},
        });

        return _this.model.destroy(id, condition, (error, model) =&gt; {
          _this._extendedCallback(&apos;deleteByIdConditional&apos;, error, model, cb);
        });
      },

      createItem: function(data, cb) {
        _this._logRumEvent({
          eventName: &apos;createItem&apos;,
          payload: {data},
        });

        return _this.model.create(data, (error, model) =&gt; {
          _this._extendedCallback(&apos;createItem&apos;, error, model, cb);
        });
      },

      createUniqueOnFields: function(fields, data, cb) {
        _this._logRumEvent({
          eventName: &apos;createUniqueOnFields&apos;,
          payload: {fields, data},
        });

        let scanCb = function(err, data) {
          if (err) {
            return cb(err, data);
          }

          if (data.Count) {
            return cb(`Item like ${data} already exists`);
          }

          return _this.model.create(data, cb);
        };

        let scanParams = {};
        for (let fieldKey in fields) {
          if (!fields.hasOwnProperty(fieldKey)) {
            continue;
          }

          let field = fields[fieldKey];

          scanParams[field] = data[field];
        }

        scanParams = ExtendModel.buildScanParameters(scanParams);

        return _this.model
          .scan()
          .filterExpression(scanParams.filterExpression)
          .expressionAttributeValues(scanParams.filterExpressionValues)
          .expressionAttributeNames(scanParams.filterExpressionNames)
          .limit(1)
          .exec((error, model) =&gt; {
            _this._extendedCallback(&apos;createItem&apos;, error, model, scanCb);
          });
      },

      updateItem: function(id, data, cb) {
        _this._logRumEvent({
          eventName: &apos;updateItem&apos;,
          payload: {id, data},
        });

        data.Id = id;

        return _this.model.update(data, (error, model) =&gt; {
          _this._extendedCallback(&apos;updateItem&apos;, error, model, cb);
        });
      },

      updateItemConditional: function(id, data, condition, cb) {
        _this._logRumEvent({
          eventName: &apos;updateItemConditional&apos;,
          payload: {id, data, condition},
        });

        data.Id = id;

        return _this.model.update(data, condition, (error, model) =&gt; {
          _this._extendedCallback(&apos;updateItemConditional&apos;, error, model, cb);
        });
      },
    };
  }

  /**
   * Injects the specified methods or all
   *
   * @param {Array} methods
   */
  inject(methods = null) {
    let predefinedMethods = this.methods;
    let predefinedMethodsNames = Object.keys(predefinedMethods);

    methods = methods || predefinedMethodsNames;

    for (let methodKey in methods) {
      if (!methods.hasOwnProperty(methodKey)) {
        continue;
      }

      let methodName = methods[methodKey];

      if (!predefinedMethods.hasOwnProperty(methodName)) {
        throw new UndefinedMethodException(methodName, predefinedMethodsNames);
      }

      this._model[methodName] = predefinedMethods[methodName];
    }

    return this._model;
  }

  /**
   * @param {Object} customData
   * @returns {Boolean}
   * @private
   */
  _logRumEvent(customData) {
    if (!this.model.logService) {
      return false;
    }

    let event = util._extend(customData, {
      service: &apos;deep-db&apos;,
      resourceType: &apos;DynamoDB&apos;,
      resourceId: this.model.tableName(),
    });

    this.model.logService.rumLog(event);

    return true;
  }

  /**
   * @param {String} methodName
   * @param {Object} error
   * @param {Object} model
   * @param {Function} cb
   * @private
   */
  _extendedCallback(methodName, error, model, cb) {
    let data = null;
    if (model) {
      data = model.Items ? model : model.get();
    }

    this._logRumEvent({
      eventName: methodName,
      payload: {
        error: error,
        data: data,
      }
    });

    cb(error, model);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.3.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
